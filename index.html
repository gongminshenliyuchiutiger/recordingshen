<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>錄音檔案即時逐字稿暨重點摘要系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f4f8;
        }
        .recording-pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        .paused-indicator {
            background-color: #f59e0b; /* amber-500 */
        }
        .processing-indicator {
             background-color: #3b82f6; /* blue-500 */
             animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .transcript-container,
        .summary-container {
            height: 300px;
            overflow-y: auto;
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 4px;
            background-color: white;
            font-family: 'Noto Sans TC', sans-serif;
            resize: vertical;
            line-height: 1.6;
        }
        .transcript-container {
             white-space: pre-wrap;
             word-wrap: break-word;
        }
        .audio-player {
            width: 100%;
            margin-top: 1rem;
        }
        .audio-player:focus { outline: none; }
        .footer {
            text-align: center;
            padding: 1rem;
            margin-top: 2rem;
            color: #4a5568; /* gray-700 */
            font-size: 0.875rem;
        }

        .control-button, .file-upload-label {
             display: inline-flex;
             align-items: center;
             justify-content: center;
             font-weight: 500;
             padding-top: 0.5rem; padding-bottom: 0.5rem;
             padding-left: 1.25rem; padding-right: 1.25rem;
             transition: all 0.2s ease-in-out;
             cursor: pointer;
             white-space: nowrap;
             color: white;
             border: none;
             outline: none;
        }

        .control-button i, .file-upload-label i { margin-right: 0.5rem; }

         .control-button:disabled, .file-upload-label:disabled {
             opacity: 0.5;
             cursor: not-allowed;
         }

        .icon-button {
             background: none;
             border: none;
             padding: 0.25rem;
             cursor: pointer;
             display: inline-flex;
             align-items: center;
             justify-content: center;
             color: #4f46e5;
             transition: color 0.2s;
             border-radius: 9999px;
             outline: none;
        }
        .icon-button:hover:not(:disabled) {
            color: #3730a3;
            background-color: #e0e7ff;
        }
         .icon-button.danger:hover:not(:disabled) {
             color: #dc2626;
             background-color: #fee2e2;
         }
          .icon-button:disabled {
              opacity: 0.5;
              cursor: not-allowed;
          }
        .icon-button svg, .icon-button i {
            width: 1.25rem;
            height: 1.25rem;
        }
        .tooltip {
          position: relative;
          display: inline-block;
        }
        .tooltip .tooltiptext {
          visibility: hidden;
          width: 80px;
          background-color: #555;
          color: #fff;
          text-align: center;
          border-radius: 6px;
          padding: 5px 0;
          position: absolute;
          z-index: 10;
          bottom: 125%;
          left: 50%;
          margin-left: -40px;
          opacity: 0;
          transition: opacity 0.3s;
          font-size: 0.75rem;
          pointer-events: none;
        }
        .tooltip:hover .tooltiptext {
          visibility: visible;
          opacity: 1;
        }
        input[type="file"] {
            display: none;
        }
        /* --- New API Key Section Styles --- */
        .api-key-section {
            background-color: #eef2ff; /* indigo-50 */
            border: 1px solid #c7d2fe; /* indigo-200 */
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .api-info-box {
            padding: 0.75rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            border-left-width: 4px;
            font-size: 0.9rem;
        }
        .api-info-box-info {
            background-color: #dbeafe; /* blue-100 */
            border-color: #3b82f6; /* blue-500 */
            color: #1e3a8a; /* blue-900 */
        }
        .api-label-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .api-label-wrapper label {
            font-weight: 500;
            color: #3730a3; /* indigo-800 */
        }
        .api-options {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        .api-tutorial-link {
            color: #3b82f6; /* blue-500 */
            text-decoration: none;
            font-size: 0.9em;
            cursor: pointer;
        }
        .api-tutorial-link:hover { text-decoration: underline; }
        #geminiApiKey {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem;
            outline: none;
        }
        #geminiApiKey:focus {
            border-color: #4f46e5; /* indigo-600 */
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
        #geminiApiKey:disabled { background-color: #f3f4f6; cursor: not-allowed; opacity: 0.7; }

        /* --- Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; animation: fadeInModal 0.3s; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: white; padding: 2rem; border-radius: 0.5rem; max-width: 600px; width: 90%; position: relative; max-height: 80vh; overflow-y: auto; }
        .modal-close { position: absolute; top: 0.75rem; right: 1rem; font-size: 1.75rem; color: #9ca3af; cursor: pointer; transition: color 0.2s; }
        .modal-close:hover { color: #1f2937; }
        .modal-content h3 { font-size: 1.5rem; color: #1e3a8a; margin-bottom: 1rem; }
        .modal-content p, .modal-content li { margin-bottom: 0.75rem; line-height: 1.6; color: #374151; }
        .modal-content ol { padding-left: 1.25rem; }
        .modal-content code { background-color: #e5e7eb; padding: 0.125rem 0.25rem; border-radius: 0.25rem; font-family: monospace; }
        .modal-content a { color: #3b82f6; text-decoration: none; font-weight: 500; }
        .modal-content a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <h1 class="text-3xl font-bold text-center text-indigo-800 mb-8">
             <i class="fa-solid fa-headphones-simple mr-2"></i>錄音檔案即時逐字稿暨重點摘要系統
        </h1>

        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex flex-col sm:flex-row items-center justify-between mb-4">
                <div class="flex items-center mb-2 sm:mb-0">
                    <div id="recordingStatus" class="w-4 h-4 rounded-full bg-gray-400 mr-2 transition-colors duration-300 flex-shrink-0"></div>
                    <span id="statusText" class="text-lg font-medium text-gray-700">準備就緒</span>
                </div>
                 <span id="uploadStatus" class="text-sm text-gray-500 h-5"></span>
            </div>

            <div class="flex flex-wrap items-center justify-center md:justify-between gap-2 mb-6">
                <div class="flex items-center space-x-2">
                     <label for="audioFileInput"
                            class="file-upload-label rounded-full bg-emerald-600 hover:bg-emerald-700 focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500 px-5">
                        <i class="fa-solid fa-upload"></i>上傳音檔
                    </label>
                    <input type="file" id="audioFileInput" accept="audio/*">
                    <span id="fileName" class="text-sm text-gray-600 truncate max-w-xs"></span>
                </div>
                <div class="flex space-x-2 flex-wrap justify-center">
                    <button id="startRecording" class="control-button rounded-full bg-indigo-600 hover:bg-indigo-700 focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 px-5">
                        <i class="fa-solid fa-microphone"></i>開始錄音
                    </button>
                    <button id="pauseRecording" class="control-button rounded-full bg-amber-500 hover:bg-amber-600 focus:ring-2 focus:ring-offset-2 focus:ring-amber-400 hidden px-5">
                        <i class="fa-solid fa-pause"></i>暫停錄音
                    </button>
                    <button id="resumeRecording" class="control-button rounded-full bg-emerald-500 hover:bg-emerald-600 focus:ring-2 focus:ring-offset-2 focus:ring-emerald-400 hidden px-5">
                        <i class="fa-solid fa-play"></i>繼續錄音
                    </button>
                    <button id="stopRecording" class="control-button rounded-full bg-red-600 hover:bg-red-700 focus:ring-2 focus:ring-offset-2 focus:ring-red-500 hidden px-5">
                        <i class="fa-solid fa-stop"></i>停止錄音
                    </button>
                </div>
            </div>

            <!-- API Key Section -->
            <div class="api-key-section">
                <div class="api-info-box api-info-box-info" id="apiInfoBox">
                    <p id="apiInfoText">請提供您的 Google Gemini API 金鑰以啟用AI功能 (音檔轉錄 & 重點摘要)。</p>
                </div>
                <div class="api-label-wrapper">
                    <label for="geminiApiKey">您的 API 金鑰 (必填)</label>
                    <div class="api-options">
                        <a href="#" class="api-tutorial-link">(如何取得？)</a>
                    </div>
                </div>
                <input type="password" id="geminiApiKey" autocomplete="off" placeholder="請貼上您從 Google AI Studio 取得的 API 金鑰">
            </div>

            <div id="audioSection" class="mb-6 hidden">
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
                    <h2 class="text-xl font-semibold mb-3 text-indigo-700">
                       <i class="fa-solid fa-circle-play mr-2"></i>音檔播放
                    </h2>
                    <audio id="audioPlayer" class="audio-player" controls></audio>
                    <div id="downloadSection" class="flex justify-end mt-3">
                         <div class="tooltip">
                            <button id="downloadButton"
                                    class="control-button rounded-full bg-green-600 hover:bg-green-700 focus:ring-2 focus:ring-offset-2 focus:ring-green-500 flex items-center px-5">
                                <i class="fa-solid fa-download mr-2"></i>下載 MP3
                            </button>
                            <span class="tooltiptext">下載錄音</span>
                         </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <div class="w-full md:w-1/2">
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 h-full flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl font-semibold text-indigo-700">
                                <i class="fa-solid fa-file-lines mr-2"></i>逐字稿
                            </h2>
                            <div class="tooltip">
                                <button id="copyTranscript" class="icon-button" title="複製逐字稿">
                                    <i class="fa-regular fa-copy"></i>
                                </button>
                                <span class="tooltiptext">複製全文</span>
                            </div>
                        </div>
                        <textarea id="transcript" class="transcript-container text-gray-700 flex-grow" placeholder="錄音開始或上傳音檔後，逐字稿將顯示在這裡..."></textarea>
                    </div>
                </div>
                <div class="w-full md:w-1/2">
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 h-full flex flex-col">
                        <div class="flex justify-between items-center mb-3">
                            <h2 class="text-xl font-semibold text-indigo-700">
                                <i class="fa-solid fa-brain mr-2"></i>AI 重點摘要
                            </h2>
                            <div class="flex space-x-2">
                                <div class="tooltip">
                                    <button id="regenerateSummary" class="icon-button" title="重新生成摘要">
                                        <i class="fa-solid fa-arrows-rotate"></i>
                                    </button>
                                    <span class="tooltiptext">重新生成</span>
                                </div>
                                <div class="tooltip">
                                    <button id="copyMarkdown" class="icon-button" title="複製摘要">
                                        <i class="fa-regular fa-copy"></i>
                                    </button>
                                    <span class="tooltiptext">複製摘要</span>
                                </div>
                            </div>
                        </div>
                        <textarea id="markdownEditor" class="summary-container text-gray-700 flex-grow" placeholder="逐字稿生成後，AI 將生成重點摘要..."></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold mb-4 text-indigo-700">
               <i class="fa-solid fa-circle-info mr-2"></i>操作說明
            </h2>
            <ul class="list-disc pl-5 text-gray-700 space-y-2">
                <li><b>即時錄音：</b>點擊 <i class="fa-solid fa-microphone text-indigo-600"></i> 開始錄音。系統將自動轉錄語音並顯示在 <i class="fa-solid fa-file-lines text-indigo-600"></i> 逐字稿區域。</li>
                <li><b>上傳音檔：</b>點擊 <i class="fa-solid fa-upload text-emerald-500"></i> 上傳音檔按鈕，選擇您裝置上的音訊檔案 (如 MP3, WAV, M4A 等)。</li>
                <li>系統會上傳並處理檔案，完成後逐字稿會顯示在 <i class="fa-solid fa-file-lines text-indigo-600"></i> 區域。(此功能需提供 API 金鑰)</li>
                <li><b>錄音控制：</b>錄音中可點擊 <i class="fa-solid fa-pause text-amber-500"></i> 暫停，再點擊 <i class="fa-solid fa-play text-emerald-500"></i> 繼續。點擊 <i class="fa-solid fa-stop text-red-600"></i> 停止錄音。</li>
                <li><b>重點摘要：</b>錄音停止或檔案轉錄完成後，AI 會自動生成 <i class="fa-solid fa-brain text-indigo-600"></i> 重點摘要。(此功能需提供 API 金鑰)</li>
                 <li><b>編輯與重整：</b>您可以隨時編輯逐字稿內容，然後點擊 <i class="fa-solid fa-arrows-rotate text-indigo-600"></i> 按鈕，根據目前的逐字稿重新生成摘要。</li>
                 <li><b>複製與下載：</b>使用 <i class="fa-regular fa-copy text-indigo-600"></i> 按鈕複製逐字稿或摘要。在 <i class="fa-solid fa-circle-play text-indigo-600"></i> 音檔播放區可以播放音檔，若是即時錄製的音檔，可點擊 <i class="fa-solid fa-download text-green-600"></i> 下載 MP3。</li>
                 <li><b>注意：</b>檔案上傳與轉錄可能需要一些時間，具體取決於檔案大小和網路速度。處理期間請稍候。</li>
            </ul>
        </div>

        <div class="footer">
            <p>Copyright © Liyuchiutiger Gongminshen</p>
        </div>
    </div>
    
    <!-- Modal for API Key Tutorial -->
    <div class="modal-overlay" id="api-key-modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h3>如何取得免費的 Google Gemini API 金鑰？</h3>
            <p>按照以下簡單步驟，即可取得您自己的免費金鑰，享受更穩定、個人化的服務。</p>
            <ol>
                <li>前往 <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio 的 API 金鑰頁面</a>。</li>
                <li>使用您的 Google 帳號登入。</li>
                <li>點擊頁面上的 <strong>「建立 API 金鑰」(Create API key)</strong> 按鈕。</li>
                <li>系統會立即產生一組新的金鑰。點擊金鑰旁邊的複製圖示。</li>
                <li>回到本頁面，將複製的金鑰貼到輸入框中即可！</li>
            </ol>
            <p><strong>提醒：</strong>請妥善保管您的 API 金鑰，不要與他人分享。</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dom = {
                startButton: document.getElementById('startRecording'),
                stopButton: document.getElementById('stopRecording'),
                pauseButton: document.getElementById('pauseRecording'),
                resumeButton: document.getElementById('resumeRecording'),
                statusIndicator: document.getElementById('recordingStatus'),
                statusText: document.getElementById('statusText'),
                uploadStatus: document.getElementById('uploadStatus'),
                transcriptContainer: document.getElementById('transcript'),
                markdownEditor: document.getElementById('markdownEditor'),
                audioSection: document.getElementById('audioSection'),
                audioPlayer: document.getElementById('audioPlayer'),
                downloadSection: document.getElementById('downloadSection'),
                downloadButton: document.getElementById('downloadButton'),
                copyMarkdownButton: document.getElementById('copyMarkdown'),
                copyTranscriptButton: document.getElementById('copyTranscript'),
                regenerateSummaryButton: document.getElementById('regenerateSummary'),
                audioFileInput: document.getElementById('audioFileInput'),
                fileNameDisplay: document.getElementById('fileName'),
                apiKeyInput: document.getElementById('geminiApiKey'),
                apiInfoBox: document.getElementById('apiInfoBox'),
                apiInfoText: document.getElementById('apiInfoText'),
                apiKeyModal: document.getElementById('api-key-modal'),
                openApiKeyModalLink: document.querySelector('.api-tutorial-link')
            };

            let mediaRecorder;
            let audioChunks = [];
            let recognition;
            let finalTranscriptBuffer = '';
            let interimTranscript = '';
            let audioBlob;
            let audioUrl;
            let isRecording = false;
            let isPaused = false;
            let isProcessingFile = false;

            const getActiveApiKey = () => {
                return dom.apiKeyInput.value.trim();
            };

             function setProcessingState(isProcessing, message = '') {
                isProcessingFile = isProcessing;
                dom.uploadStatus.textContent = message;
                dom.startButton.disabled = isProcessing;
                dom.audioFileInput.disabled = isProcessing;
                const fileUploadLabel = document.querySelector('label[for="audioFileInput"]');
                fileUploadLabel.classList.toggle('opacity-50', isProcessing);
                fileUploadLabel.classList.toggle('cursor-not-allowed', isProcessing);

                 if (isProcessing) {
                     dom.statusIndicator.className = 'w-4 h-4 rounded-full mr-2 transition-colors duration-300 flex-shrink-0 processing-indicator';
                     dom.statusText.textContent = '處理檔案中...';
                 } else {
                     dom.statusIndicator.classList.remove('processing-indicator');
                     updateUIState();
                 }
             }

            function showCopySuccess(button, originalTitle, successIconHtml, originalIconHtml) {
                 const originalInnerHtml = button.innerHTML;
                 button.innerHTML = successIconHtml;
                 button.title = "已複製！";
                 button.disabled = true;
                 setTimeout(() => {
                    button.innerHTML = originalIconHtml;
                    button.title = originalTitle;
                    button.disabled = false;
                 }, 1500);
            }

             function updateUIState() {
                 if (isProcessingFile) return;

                 if (isRecording) {
                    dom.startButton.classList.add('hidden');
                    dom.stopButton.classList.remove('hidden');
                    dom.stopButton.disabled = false;
                    if (isPaused) {
                        dom.statusIndicator.className = 'w-4 h-4 rounded-full mr-2 transition-colors duration-300 flex-shrink-0 paused-indicator';
                        dom.statusText.textContent = '錄音已暫停';
                        dom.pauseButton.classList.add('hidden');
                        dom.resumeButton.classList.remove('hidden');
                        dom.resumeButton.disabled = false;
                    } else {
                        dom.statusIndicator.className = 'w-4 h-4 rounded-full mr-2 transition-colors duration-300 flex-shrink-0 bg-red-500 recording-pulse';
                        dom.statusText.textContent = '錄音中...';
                        dom.pauseButton.classList.remove('hidden');
                        dom.pauseButton.disabled = false;
                        dom.resumeButton.classList.add('hidden');
                    }
                     dom.audioFileInput.disabled = true;
                     document.querySelector('label[for="audioFileInput"]').classList.add('opacity-50', 'cursor-not-allowed');
                 } else {
                    dom.startButton.classList.remove('hidden');
                    dom.startButton.disabled = !browserSupportsLiveRecording;
                    dom.stopButton.classList.add('hidden');
                    dom.pauseButton.classList.add('hidden');
                    dom.resumeButton.classList.add('hidden');
                    dom.statusIndicator.className = 'w-4 h-4 rounded-full mr-2 transition-colors duration-300 flex-shrink-0 bg-gray-400';
                     if (!dom.statusText.textContent.includes('完成') && !dom.statusText.textContent.includes('錯誤') && !dom.statusText.textContent.includes('生成') && !dom.statusText.textContent.includes('停止') && !dom.statusText.textContent.includes('中止') && !dom.statusText.textContent.includes('阻止')) {
                          dom.statusText.textContent = '準備就緒';
                     }
                     dom.audioFileInput.disabled = false;
                     document.querySelector('label[for="audioFileInput"]').classList.remove('opacity-50', 'cursor-not-allowed');
                 }

                 dom.regenerateSummaryButton.disabled = dom.transcriptContainer.value.trim().length === 0;
                 dom.copyTranscriptButton.disabled = dom.transcriptContainer.value.trim().length === 0;
                 dom.copyMarkdownButton.disabled = dom.markdownEditor.value.trim().length === 0;
            }


            // --- Event Listeners ---
            dom.copyTranscriptButton.addEventListener('click', () => {
                if (!dom.transcriptContainer.value) return;
                navigator.clipboard.writeText(dom.transcriptContainer.value).then(() => {
                    showCopySuccess(dom.copyTranscriptButton, "複製逐字稿", `<i class="fa-solid fa-check text-green-600"></i>`, `<i class="fa-regular fa-copy"></i>`);
                }).catch(err => console.error('無法複製逐字稿:', err));
            });

            dom.copyMarkdownButton.addEventListener('click', () => {
                if (!dom.markdownEditor.value) return;
                navigator.clipboard.writeText(dom.markdownEditor.value).then(() => {
                     showCopySuccess(dom.copyMarkdownButton, "複製摘要", `<i class="fa-solid fa-check text-green-600"></i>`, `<i class="fa-regular fa-copy"></i>`);
                }).catch(err => console.error('無法複製摘要:', err));
            });

            dom.regenerateSummaryButton.addEventListener('click', () => {
                const currentTranscript = dom.transcriptContainer.value.trim();
                if (!currentTranscript) { alert("逐字稿是空的，無法生成摘要。"); return; }
                if (isRecording && !isPaused) { alert("請先暫停或停止錄音，再重新生成摘要。"); return; }
                if (isProcessingFile) { alert("正在處理上傳的檔案，請稍後再重新生成摘要。"); return; }
                
                const apiKey = getActiveApiKey();
                if (!apiKey) {
                    alert("請提供您的 API 金鑰以生成摘要。");
                    dom.apiKeyInput.focus();
                    return;
                }

                dom.markdownEditor.placeholder = 'AI 正在努力工作中，請稍候...';
                dom.markdownEditor.value = '';
                generateRealAISummary(currentTranscript, apiKey);
            });

            dom.audioFileInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) { dom.fileNameDisplay.textContent = ''; if (isProcessingFile) { setProcessingState(false, ''); } updateUIState(); return; }
                if (!file.type.startsWith('audio/')) { alert('請選擇一個有效的音訊檔案 (例如 MP3, WAV, M4A, OGG)。'); dom.fileNameDisplay.textContent = ''; dom.audioFileInput.value = ''; if (isProcessingFile) setProcessingState(false, '檔案格式不支援'); updateUIState(); return; }
                const maxSizeMB = 50;
                if (file.size > maxSizeMB * 1024 * 1024) { alert(`檔案大小超過 ${maxSizeMB}MB 限制，請選擇較小的檔案。`); dom.fileNameDisplay.textContent = ''; dom.audioFileInput.value = ''; if (isProcessingFile) setProcessingState(false, '檔案過大'); updateUIState(); return; }
                
                const apiKey = getActiveApiKey();
                if (!apiKey) {
                    alert("請提供您的 API 金鑰才能上傳並轉錄音檔。");
                    dom.audioFileInput.value = '';
                    dom.fileNameDisplay.textContent = '';
                    dom.apiKeyInput.focus();
                    return;
                }

                if (isRecording) { console.log("自動停止錄音以處理上傳檔案..."); stopRecordingFunction(false, true); }

                dom.fileNameDisplay.textContent = file.name;
                setProcessingState(true, '正在讀取檔案...');
                dom.transcriptContainer.value = '';
                dom.markdownEditor.value = '';
                dom.markdownEditor.placeholder = '音檔處理中...';
                const reader = new FileReader();
                reader.onloadend = () => {
                    if (reader.error) { console.error("檔案讀取錯誤:", reader.error); alert(`讀取檔案時發生錯誤: ${reader.error.message}`); setProcessingState(false, '檔案讀取失敗'); dom.fileNameDisplay.textContent = ''; dom.audioFileInput.value = ''; updateUIState(); return; }
                    try {
                        const base64String = reader.result.split(',')[1];
                        const mimeType = file.type;
                        if (audioUrl) URL.revokeObjectURL(audioUrl);
                        audioUrl = URL.createObjectURL(file);
                        dom.audioPlayer.src = audioUrl;
                        dom.audioSection.classList.remove('hidden');
                        dom.downloadSection.classList.add('hidden');
                        transcribeAudioFile(base64String, mimeType, apiKey);
                    } catch (e) { console.error("處理檔案 Data URL 失敗:", e); alert(`處理檔案時發生錯誤: ${e.message}`); setProcessingState(false, '檔案處理失敗'); dom.fileNameDisplay.textContent = ''; dom.audioFileInput.value = ''; updateUIState(); }
                };
                reader.onerror = (err) => { console.error("FileReader 錯誤:", err); alert('讀取檔案時發生錯誤。'); setProcessingState(false, '檔案讀取錯誤'); dom.fileNameDisplay.textContent = ''; dom.audioFileInput.value = ''; updateUIState(); };
                reader.readAsDataURL(file);
            });

            const browserSupportsLiveRecording = ('webkitSpeechRecognition' in window) && navigator.mediaDevices && navigator.mediaDevices.getUserMedia;
            if (!browserSupportsLiveRecording) {
                 dom.startButton.disabled = true;
                 dom.startButton.title = '您的瀏覽器不支援即時錄音功能';
                 dom.startButton.classList.add('opacity-50', 'cursor-not-allowed');
                 console.warn('瀏覽器不支援 Web Speech API 或 getUserMedia，即時錄音功能已停用。');
            }

            const initSpeechRecognition = () => {
                if (!browserSupportsLiveRecording || recognition) return;
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) { console.error("Speech Recognition API not supported in this browser."); dom.startButton.disabled = true; dom.startButton.title = '您的瀏覽器不支援語音識別 API'; dom.startButton.classList.add('opacity-50', 'cursor-not-allowed'); return; }
                recognition = new SpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'zh-TW';

                recognition.onresult = (event) => {
                    if (isProcessingFile || isPaused) return;
                    let currentInterim = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) { finalTranscriptBuffer += event.results[i][0].transcript.trim() + ' '; }
                        else { currentInterim += event.results[i][0].transcript; }
                    }
                    interimTranscript = currentInterim;
                    dom.transcriptContainer.value = finalTranscriptBuffer + interimTranscript;
                    dom.transcriptContainer.scrollTop = dom.transcriptContainer.scrollHeight;
                    updateUIState();
                };

                recognition.onerror = (event) => {
                    console.error('語音識別錯誤:', event.error);
                    if (event.error === 'no-speech' && isRecording && !isPaused) { console.log('偵測到無語音，可能需要重啟識別。'); }
                    else if (event.error === 'aborted') { console.log('語音識別被中止 (手動停止或API內部中止)'); }
                    else if (event.error === 'audio-capture') { alert('麥克風發生問題，請檢查裝置。即時錄音已停止。'); stopRecordingFunction(true); }
                    else if (event.error === 'network') { alert('網路問題導致語音識別失敗，請檢查網路連線。'); stopRecordingFunction(true); }
                    else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') { alert('麥克風權限被拒絕或語音識別服務不可用。即時錄音已停止。'); stopRecordingFunction(true); }
                    else { console.warn(`Unhandled Speech Recognition Error: ${event.error}`); }
                };

                recognition.onend = () => {
                    console.log('語音識別結束');
                    if (isRecording && !isPaused && recognition && !recognition.manualStop && !isProcessingFile) {
                        console.log('自動重啟語音識別...');
                        try {
                            setTimeout(() => { if (isRecording && !isPaused && recognition && !recognition.manualStop && !isProcessingFile) { console.log('Attempting recognition restart now.'); recognition.start(); } else { console.log('Auto-restart condition no longer met.'); } }, 500);
                        } catch (e) { console.error("重啟識別失敗:", e); if (e.name === 'InvalidStateError') { console.warn("無法在當前狀態下重啟識別。"); if (isRecording && !isProcessingFile) { alert('無法自動重啟語音識別，錄音將繼續但可能無法即時轉錄。'); } } else { console.error("其他重啟錯誤:", e); } }
                    } else { console.log(`Speech recognition ended (isRecording: ${isRecording}, isPaused: ${isPaused}, manualStop: ${recognition?.manualStop}, isProcessingFile: ${isProcessingFile})`); }
                    if(recognition) recognition.manualStop = false;
                };
                window.speechRecognitionInstance = recognition;
            };

            dom.startButton.addEventListener('click', async () => {
                if (isRecording || isProcessingFile) return;
                 if (!browserSupportsLiveRecording) { alert('您的瀏覽器不支援即時錄音功能。'); return; }
                try {
                    dom.transcriptContainer.value = ''; dom.markdownEditor.value = '';
                    dom.markdownEditor.placeholder = '錄音結束後，AI 將生成重點摘要...';
                    dom.audioSection.classList.add('hidden'); dom.downloadSection.classList.add('hidden');
                    dom.fileNameDisplay.textContent = ''; dom.audioFileInput.value = '';
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    isRecording = true; isPaused = false;
                    audioChunks = []; finalTranscriptBuffer = ''; interimTranscript = '';
                    if (audioUrl) URL.revokeObjectURL(audioUrl); audioUrl = null; audioBlob = null;
                    let options = { mimeType: 'audio/webm;codecs=opus' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) { options = { mimeType: 'audio/webm' }; if (!MediaRecorder.isTypeSupported(options.mimeType)) { options = { mimeType: 'audio/ogg;codecs=opus' }; if (!MediaRecorder.isTypeSupported(options.mimeType)) { options = { mimeType: 'audio/ogg' }; if (!MediaRecorder.isTypeSupported(options.mimeType)) { console.warn("Opus/Webm/Ogg not fully supported, trying default..."); options = {}; }}}}
                     console.log("Using MediaRecorder options:", options);
                    mediaRecorder = new MediaRecorder(stream, options);
                    mediaRecorder.ondataavailable = (event) => { if (event.data.size > 0) { audioChunks.push(event.data); } };
                    mediaRecorder.onstop = () => {
                        console.log('MediaRecorder 停止');
                        const wasRecording = isRecording; isRecording = false; isPaused = false;
                        if (stream && stream.getTracks) { stream.getTracks().forEach(track => track.stop()); console.log('Stream tracks stopped.'); } else { console.warn("Could not stop stream tracks."); }
                        if (audioChunks.length > 0) {
                           const recordedMimeType = audioChunks[0].type || options.mimeType || 'audio/webm;codecs=opus';
                           console.log("Recorded MIME Type:", recordedMimeType);
                           audioBlob = new Blob(audioChunks, { type: recordedMimeType });
                            if (audioUrl) URL.revokeObjectURL(audioUrl); audioUrl = URL.createObjectURL(audioBlob);
                            dom.audioPlayer.src = audioUrl; dom.audioSection.classList.remove('hidden'); dom.downloadSection.classList.remove('hidden');
                            dom.downloadButton.onclick = () => { try { saveAs(audioBlob, `錄音_${new Date().toISOString().slice(0,19).replace(/[-:T]/g, '')}.mp3`); } catch (e) { console.error("FileSaver saveAs 錯誤:", e); const a = document.createElement('a'); a.style.display = 'none'; a.href = audioUrl; let extension = '.webm'; if (recordedMimeType.includes('ogg')) extension = '.ogg'; if (recordedMimeType.includes('mp4')) extension = '.mp4'; a.download = `錄音_${new Date().toISOString().slice(0,19).replace(/[-:T]/g, '')}${extension}`; document.body.appendChild(a); a.click(); window.URL.revokeObjectURL(a.href); document.body.removeChild(a); }};
                        } else { console.log("No audio chunks recorded."); dom.audioSection.classList.add('hidden'); dom.downloadSection.classList.add('hidden'); }
                        mediaRecorder = null; audioChunks = [];
                        const finalTranscript = dom.transcriptContainer.value.trim();
                        if (finalTranscript && wasRecording) {
                            const apiKey = getActiveApiKey();
                            if(apiKey) {
                                dom.markdownEditor.placeholder = 'AI 正在努力工作中，請稍候...';
                                generateRealAISummary(finalTranscript, apiKey);
                            } else {
                                dom.markdownEditor.placeholder = '請提供 API 金鑰以生成摘要。';
                                alert('錄音已結束。請提供您的 API 金鑰以生成重點摘要。');
                                updateUIState();
                            }
                        } else if (wasRecording) { dom.statusText.textContent = '錄音結束，無逐字稿'; dom.markdownEditor.placeholder = '錄音結束，無逐字稿可供摘要。'; updateUIState(); } else { if (!isProcessingFile) updateUIState(); }
                    };
                     mediaRecorder.onerror = (event) => { console.error("MediaRecorder 錯誤:", event.error); alert(`錄音錯誤: ${event.error.name || event.error}`); stopRecordingFunction(true); };
                    mediaRecorder.start(1000);
                    initSpeechRecognition();
                    if(recognition) { recognition.manualStop = false; try { recognition.start(); console.log("Speech recognition started."); } catch (recogStartError) { console.error("無法啟動語音識別:", recogStartError); if (recogStartError.name !== 'InvalidStateError') { alert('無法啟動語音識別，錄音將繼續但無法即時轉錄。'); } else { console.warn("語音識別已在運行中或狀態不正確。"); } } } else { alert('語音識別API初始化失敗，錄音將繼續但無法即時轉錄。'); }
                    updateUIState();
                } catch (err) { console.error('啟動錄音/識別失敗:', err); if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') { alert('無法啟動錄音：需要麥克風權限。請在瀏覽器設定中允許麥克風存取。'); } else if (err.name === 'NotFoundError' || err.name === 'DevicesNotFoundError') { alert('無法啟動錄音：找不到可用的麥克風裝置。'); } else if (err.name === 'NotReadableError' || err.name === 'TrackStartError') { alert('無法啟動錄音：麥克風目前可能被其他應用程式佔用或發生硬體錯誤。'); } else { alert('無法啟動錄音：' + (err.message || '未知錯誤') + '\n請檢查麥克風權限或裝置。'); } isRecording = false; isPaused = false; updateUIState(); if (recognition) { try { recognition.abort(); } catch(e){} recognition = null; } if (mediaRecorder && mediaRecorder.state !== 'inactive') { try { mediaRecorder.stop(); } catch(e){} } mediaRecorder = null; audioChunks = []; }
            });

            dom.pauseButton.addEventListener('click', () => {
                if (!isRecording || isPaused || !mediaRecorder || isProcessingFile || mediaRecorder.state !== 'recording') return;
                console.log('Pausing...'); try { mediaRecorder.pause(); if (recognition) { recognition.manualStop = true; recognition.stop(); console.log('Speech recognition stopped for pause.'); } isPaused = true; updateUIState(); } catch (e) { console.error("Pause failed:", e); alert("暫停失敗，請檢查控制台。"); }
            });

            dom.resumeButton.addEventListener('click', () => {
                if (!isRecording || !isPaused || !mediaRecorder || isProcessingFile || mediaRecorder.state !== 'paused') return;
                console.log('Resuming...'); try { mediaRecorder.resume(); if (recognition) { recognition.manualStop = false; recognition.start(); console.log('Speech recognition restarted for resume.'); } isPaused = false; updateUIState(); } catch(e) { console.error("Resume failed:", e); alert("繼續錄音失敗，請檢查控制台。"); }
            });

            dom.stopButton.addEventListener('click', () => { stopRecordingFunction(false, false); });

             function stopRecordingFunction(isError = false, stoppedForFileUpload = false) {
                 const canStopMediaRecorder = mediaRecorder && (mediaRecorder.state === 'recording' || mediaRecorder.state === 'paused');
                 const canStopRecognition = window.speechRecognitionInstance;
                 if (!canStopMediaRecorder && !canStopRecognition && !stoppedForFileUpload) { console.log("No active recording or recognition to stop."); isRecording = false; isPaused = false; if(window.speechRecognitionInstance) { try { window.speechRecognitionInstance.abort(); } catch(e){} window.speechRecognitionInstance = null; } if (!isProcessingFile) updateUIState(); return; }
                 console.log(`Stopping recording... (Error: ${isError}, For File Upload: ${stoppedForFileUpload})`);
                 const wasRecordingState = isRecording; isRecording = false; isPaused = false;
                 if (canStopRecognition) { canStopRecognition.manualStop = true; try { canStopRecognition.abort(); console.log("Speech recognition aborted."); } catch (e) { console.error("Error aborting recognition:", e); } window.speechRecognitionInstance = null; }
                 if (canStopMediaRecorder) { try { mediaRecorder.stop(); console.log("MediaRecorder stop requested."); } catch (e) { console.error("Error stopping MediaRecorder:", e); isRecording = false; isPaused = false; if (mediaRecorder && mediaRecorder.stream) { mediaRecorder.stream.getTracks().forEach(track => track.stop()); } if (!isProcessingFile) { updateUIState(); dom.statusText.textContent = "停止錄音時發生錯誤"; } audioChunks = []; mediaRecorder = null; } }
                 else { console.warn("MediaRecorder was not active during stop request."); isRecording = false; isPaused = false; if (mediaRecorder && mediaRecorder.stream) { mediaRecorder.stream.getTracks().forEach(track => track.stop()); } mediaRecorder = null; if (!stoppedForFileUpload && !isProcessingFile) { updateUIState(); if (wasRecordingState) { dom.statusText.textContent = "錄音已停止"; } else { dom.statusText.textContent = "準備就緒"; }} audioChunks = []; const finalTranscript = dom.transcriptContainer.value.trim(); if (wasRecordingState && finalTranscript && !isProcessingFile) { console.log("Triggering summary after stopping recognition (no active MediaRecorder)."); const apiKey = getActiveApiKey(); if(apiKey) { generateRealAISummary(finalTranscript, apiKey); } else { alert("錄音已結束。請提供API金鑰以生成摘要。"); } } }
            }

            async function transcribeAudioFile(base64Data, mimeType, apiKey) {
                console.log(`向 Gemini API 發送轉錄請求 (MIME: ${mimeType})...`);
                setProcessingState(true, '正在轉錄音檔...');
                dom.regenerateSummaryButton.disabled = true; dom.copyTranscriptButton.disabled = true; dom.copyMarkdownButton.disabled = true;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: "請將此音訊檔案轉錄成符合台灣口語習慣的文字逐字稿，包含適當的標點符號。" }, { inlineData: { mimeType: mimeType, data: base64Data } }]}], safetySettings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },{ category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },{ category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },{ category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }], generationConfig: { temperature: 0.3 } }),
                    });
                    if (!response.ok) { let errorMsg = `API請求失敗: ${response.status} ${response.statusText}`; try { const errorData = await response.json(); console.error('Gemini API Error Response:', errorData); if (errorData?.error?.message) { errorMsg += ` - ${errorData.error.message}`; } else { errorMsg += ` - 未知API錯誤`; }} catch (e) {} throw new Error(errorMsg); }
                    const data = await response.json();
                    if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const transcriptText = data.candidates[0].content.parts[0].text;
                        dom.transcriptContainer.value = transcriptText.trim();
                        console.log("成功獲取轉錄稿.");
                        setProcessingState(false, '轉錄完成！');
                        generateRealAISummary(transcriptText, apiKey);
                    } else if (data.promptFeedback?.blockReason) { throw new Error(`請求因 ${data.promptFeedback.blockReason} 被阻止。`); }
                    else if (data.candidates?.[0]?.finishReason && data.candidates[0].finishReason !== 'STOP') { throw new Error(`轉錄因 "${data.candidates[0].finishReason}" 而中止。`); }
                    else { const detail = JSON.stringify(data); throw new Error(`無法從 API 回應中提取有效的轉錄內容。`); }
                } catch (error) { console.error('調用 Gemini API 進行轉錄時發生錯誤:', error); dom.transcriptContainer.value = `轉錄檔案時遇到錯誤：\n${error.message}\n\n請檢查檔案格式、API 金鑰或網路連線。`; setProcessingState(false, '轉錄失敗'); dom.statusText.textContent = '轉錄失敗'; dom.fileNameDisplay.textContent = ''; dom.markdownEditor.value = ''; dom.markdownEditor.placeholder = '轉錄失敗，無法生成摘要。'; }
            }

            async function generateRealAISummary(transcript, apiKey) {
                 if (isProcessingFile) { console.log("延遲摘要生成，等待檔案處理完成..."); return; }
                 if (!transcript || transcript.trim().length === 0) { console.log("無逐字稿，取消摘要。"); dom.markdownEditor.value = ''; dom.markdownEditor.placeholder = '無逐字稿可供摘要。'; updateUIState(); return; }
                console.log("向 Gemini API 發送摘要請求...");
                dom.markdownEditor.placeholder = 'AI 摘要生成中...'; dom.markdownEditor.value = '';
                dom.statusIndicator.className = 'w-4 h-4 rounded-full mr-2 transition-colors duration-300 flex-shrink-0 bg-yellow-500';
                dom.statusText.textContent = '正在生成摘要...';
                dom.regenerateSummaryButton.disabled = true; dom.copyMarkdownButton.disabled = true;
                const prompt = `請根據以下逐字稿，生成一份簡潔、重點清晰的摘要，捕捉主要的討論內容、想法、結論或關鍵信息。摘要風格力求自然易懂，使用 Markdown 格式化重點 (例如使用標題、列表)。\n\n逐字稿內容：\n"${transcript}"\n\n摘要 (Markdown 格式)：`;
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: prompt }] }], safetySettings: [{ category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },{ category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },{ category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },{ category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }], generationConfig: { temperature: 0.7, maxOutputTokens: 1024 } }),
                    });
                    if (!response.ok) { let errorMsg = `API請求失敗: ${response.status} ${response.statusText}`; try { const errorData = await response.json(); if (errorData?.error?.message) { errorMsg += ` - ${errorData.error.message}`; }} catch (e) {} throw new Error(errorMsg); }
                    const data = await response.json();
                     if (data.candidates?.[0]?.content?.parts?.[0]?.text) {
                        const summaryText = data.candidates[0].content.parts[0].text;
                        dom.markdownEditor.value = summaryText.trim();
                        dom.markdownEditor.placeholder = '摘要已生成。'; dom.statusText.textContent = '摘要完成！';
                    } else if (data.promptFeedback?.blockReason) { dom.markdownEditor.value = `抱歉，摘要請求因 "${data.promptFeedback.blockReason}" 被阻止。`; dom.statusText.textContent = '摘要被阻止'; }
                    else if (data.candidates?.[0]?.finishReason && data.candidates[0].finishReason !== 'STOP') { dom.markdownEditor.value = `抱歉，摘要生成因 "${data.candidates[0].finishReason}" 而中止。`; dom.statusText.textContent = '摘要中止'; }
                    else { dom.markdownEditor.value = "抱歉，無法從 API 回應中提取有效的摘要內容。"; dom.statusText.textContent = '摘要失敗'; }
                } catch (error) { console.error('調用 Gemini API 生成摘要時發生錯誤:', error); dom.markdownEditor.value = `生成摘要時遇到錯誤：\n${error.message}`; dom.statusText.textContent = '摘要失敗'; }
                finally { dom.statusIndicator.classList.remove('bg-yellow-500'); if (!isProcessingFile) { updateUIState(); if (isRecording) { updateUIState(); } } else { dom.statusIndicator.classList.add('processing-indicator'); dom.statusText.textContent = '檔案處理中...'; } }
            }

            // --- API Key Modal ---
            dom.openApiKeyModalLink.addEventListener('click', (e) => {
                e.preventDefault();
                dom.apiKeyModal.style.display = 'flex';
            });
            dom.apiKeyModal.addEventListener('click', (e) => {
                if(e.target.classList.contains('modal-overlay') || e.target.classList.contains('modal-close')) {
                    dom.apiKeyModal.style.display = 'none';
                }
            });

             updateUIState();
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</body>
</html>